rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ======== USERS COLLECTION ========
    match /users/{userId} {
      // User can manage their own profile
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Admin full control
      allow read, list, create, update, delete: if request.auth != null &&
        request.auth.uid == "SVgguK338QZ4WmLmfOSfOwgGEPB3";

      // Temporary dev read access till Dec 31, 2025
      allow read: if request.time < timestamp.date(2025, 12, 31);
    }

    // ======== COMPLAINTS COLLECTION ========
    match /complaints/{complaintId} {
      // Any logged-in user can file a complaint
      allow create: if request.auth != null;

      // User can view/manage only their own complaints
      allow read, update, delete: if request.auth != null && request.auth.uid == resource.data.userId;

      // Admin full access
      allow read, list, create, update, delete: if request.auth != null &&
        request.auth.uid == "SVgguK338QZ4WmLmfOSfOwgGEPB3";

      // Temporary dev access till Dec 31, 2025
      allow read, list, update: if request.time < timestamp.date(2025, 12, 31);
    }

    // ======== ANNOUNCEMENTS COLLECTION ========
    match /announcements/{docId} {
      allow read: if request.auth != null;

      // Admin-only CRUD
      allow create, update, delete: if request.auth != null &&
        request.auth.uid == "SVgguK338QZ4WmLmfOSfOwgGEPB3";

      // Temporary dev access
      allow read, list, create, update, delete: if request.time < timestamp.date(2025, 12, 31);
    }

    // ======== OUTPASS REQUESTS COLLECTION ========
    match /outpassRequests/{reqId} {
      // Any logged-in user can create an outpass request
      allow create: if request.auth != null;

      // User can view/manage their own request
      allow read, update, delete: if request.auth != null && request.auth.uid == resource.data.userId;

      // Admin full access
      allow read, list, create, update, delete: if request.auth != null &&
        request.auth.uid == "SVgguK338QZ4WmLmfOSfOwgGEPB3";

      // Temporary dev access till Dec 31, 2025
      allow read, list, update: if request.time < timestamp.date(2025, 12, 31);
    }

    // ======== NOTICES COLLECTION ========
    match /notices/{noticeId} {
      allow read: if request.auth != null;

      // Admin-only CRUD
      allow create, update, delete: if request.auth != null &&
        request.auth.uid == "SVgguK338QZ4WmLmfOSfOwgGEPB3";

      // Temporary dev access
      allow read, list, create, update, delete: if request.time < timestamp.date(2025, 12, 31);
    }

    // ======== NEWS BOARD COLLECTION ========
    match /newsBoard/{postId} {
      // Everyone can read
      allow read: if true;

      // Admin-only CRUD
      allow create, update, delete: if request.auth != null &&
        request.auth.uid == "SVgguK338QZ4WmLmfOSfOwgGEPB3";

      // Temporary dev access
      allow read, list, create, update, delete: if request.time < timestamp.date(2025, 12, 31);
    }

    // ======== REGISTRATIONS COLLECTION ========
    match /registrations/{regId} {
      allow create: if request.auth != null;

      // User can read/update their own registration
      allow read, update: if request.auth != null && request.auth.uid == resource.data.userId;

      // Admin full access
      allow read, list, create, update, delete: if request.auth != null &&
        request.auth.uid == "SVgguK338QZ4WmLmfOSfOwgGEPB3";

      // Temporary dev access till Dec 31, 2025
      allow read, list, update: if request.time < timestamp.date(2025, 12, 31);
    }

    // ======== APPLICATION FORMS COLLECTION ========
    match /applicationForms/{formId} {
      // Anyone can submit an application form (no login required)
      allow create: if true;

      // Admin full access (by UID or email)
      allow read, list, update, delete: if request.auth != null && (
        request.auth.uid == "SVgguK338QZ4WmLmfOSfOwgGEPB3" ||
        request.auth.token.email == "admin@militaryhostel.com"
      );

      // Temporary dev access till Dec 31, 2025
      allow read, list, update, delete: if request.time < timestamp.date(2025, 12, 31);
    }
  }
}
